<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Support Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .message {
            animation: slideIn 0.3s ease-out;
        }

        .status-dot {
            animation: pulse 2s infinite;
        }

        .typing-dot {
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-purple-700 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl h-screen md:h-[90vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-5 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl shadow-md">ü§ñ</div>
                <div>
                    <h1 class="text-xl font-semibold">E-commerce Support Bot</h1>
                    <p class="text-sm text-indigo-100">RAG-powered with Gemini AI & MySQL</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-4 py-2 bg-white/20 rounded-full text-sm backdrop-blur-sm">
                    <div class="status-dot w-2 h-2 bg-green-400 rounded-full"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="chatMessages" class="flex-1 overflow-y-auto bg-slate-50 px-6 py-6 space-y-5">
            <div class="message flex gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-700 text-white flex items-center justify-center flex-shrink-0 text-lg">ü§ñ</div>
                <div class="flex-1">
                    <div class="bg-white rounded-2xl px-5 py-3 shadow-sm text-slate-900 text-sm leading-relaxed max-w-xs">
                        Hello! I'm your customer support assistant. I can help you track orders, process returns, answer questions about shipping, and more. How can I assist you today?
                    </div>
                    <div class="flex items-center gap-2 mt-2 px-2">
                        <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">AI Greeting</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Container -->
        <div class="bg-white border-t border-slate-200 px-6 py-5 space-y-4">
            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-2">
                <button class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full text-sm font-medium transition-all duration-200 hover:-translate-y-0.5" onclick="sendQuickMessage('Where is my order 12345?')">
                    üì¶ Track Order
                </button>
                <button class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full text-sm font-medium transition-all duration-200 hover:-translate-y-0.5" onclick="sendQuickMessage('How do I return an item?')">
                    ‚Ü©Ô∏è Return Policy
                </button>
                <button class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full text-sm font-medium transition-all duration-200 hover:-translate-y-0.5" onclick="sendQuickMessage('What are the shipping options?')">
                    üöö Shipping Info
                </button>
                <button class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full text-sm font-medium transition-all duration-200 hover:-translate-y-0.5" onclick="sendQuickMessage('What payment methods do you accept?')">
                    üí≥ Payment Info
                </button>
            </div>

            <!-- Input Wrapper -->
            <div class="flex gap-3 items-center">
                <input 
                    type="text" 
                    class="chat-input flex-1 px-5 py-3 border-2 border-slate-200 rounded-full text-sm focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all duration-200" 
                    id="chatInput" 
                    placeholder="Type your message..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn w-12 h-12 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-full flex items-center justify-center hover:shadow-lg hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100 text-xl" id="sendBtn" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        let conversationContext = {};
        const API_URL = 'http://localhost:5000/api/chat';

        function addMessage(text, sender, type = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message flex gap-3 ${sender === 'user' ? 'flex-row-reverse' : ''}`;

            const avatar = document.createElement('div');
            avatar.className = `w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-lg ${
                sender === 'bot' 
                    ? 'bg-gradient-to-br from-indigo-600 to-purple-700 text-white' 
                    : 'bg-slate-200 text-slate-700'
            }`;
            avatar.textContent = sender === 'bot' ? 'ü§ñ' : 'üë§';

            const contentDiv = document.createElement('div');
            contentDiv.className = `flex-1 ${sender === 'user' ? 'flex flex-col items-end' : ''}`;

            const bubble = document.createElement('div');
            bubble.className = `rounded-2xl px-5 py-3 text-sm leading-relaxed max-w-xs ${
                sender === 'bot'
                    ? 'bg-white text-slate-900 shadow-sm'
                    : 'bg-gradient-to-r from-indigo-600 to-purple-700 text-white'
            }`;
            bubble.textContent = text;

            contentDiv.appendChild(bubble);

            if (sender === 'bot' && type) {
                const meta = document.createElement('div');
                meta.className = 'flex items-center gap-2 mt-2 px-2';
                
                let badgeClass = 'inline-block px-3 py-1 rounded-full text-xs font-medium';
                let badgeText = '';

                switch(type) {
                    case 'database_response':
                        badgeClass += ' bg-blue-100 text-blue-700';
                        badgeText = 'üóÑÔ∏è From Database';
                        break;
                    case 'knowledge_base_response':
                        badgeClass += ' bg-purple-100 text-purple-700';
                        badgeText = 'üìö Knowledge Base';
                        break;
                    case 'generated_response':
                    case 'fallback':
                        badgeClass += ' bg-pink-100 text-pink-700';
                        badgeText = 'ü§ñ Gemini AI';
                        break;
                    case 'escalation':
                        badgeClass += ' bg-pink-100 text-pink-700';
                        badgeText = '‚ö†Ô∏è Escalation';
                        break;
                    default:
                        badgeClass += ' bg-slate-100 text-slate-700';
                        badgeText = 'üí¨ Response';
                }

                const badge = document.createElement('span');
                badge.className = badgeClass;
                badge.textContent = badgeText;
                meta.appendChild(badge);
                contentDiv.appendChild(meta);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message flex gap-3';
            typingDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'w-10 h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-700 text-white flex items-center justify-center flex-shrink-0 text-lg';
            avatar.textContent = 'ü§ñ';

            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'flex gap-1 px-5 py-3 bg-white rounded-2xl shadow-sm';

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot w-2 h-2 bg-slate-400 rounded-full';
                dotsDiv.appendChild(dot);
            }

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(dotsDiv);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            sendBtn.disabled = true;

            // Show typing indicator
            showTypingIndicator();

            try {
                // Send message to backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        context: conversationContext
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                // Add bot response
                addMessage(data.message, 'bot', data.type);

                // Update conversation context
                conversationContext = data.context || {};

                // If escalation is needed, show follow-up option
                if (data.needs_escalation) {
                    setTimeout(() => {
                        addMessage(
                            'üìû Would you like me to create a support ticket for you? Just say "yes" or "create ticket".',
                            'bot',
                            'escalation'
                        );
                    }, 1000);
                }

            } catch (error) {
                hideTypingIndicator();
                addMessage(
                    'Sorry, I\'m having trouble connecting to the server. Please try again in a moment.',
                    'bot',
                    'error'
                );
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Focus input on load
        window.onload = function() {
            document.getElementById('chatInput').focus();
        };
    </script>
</body>
</html>